<?php

use PHPUnit\Framework\TestCase;
use jpuck\avhost\Core\Utils\Signature;
use jpuck\avhost\Core\Configuration;

class SignatureTest extends TestCase
{
    public function getConfiguration(array $replace = null) : Configuration
    {
        $array = [
            'hostname' => 'example.com',
            'documentRoot' => '/var/www/html',
            'meta' => [
                'realpaths' => false,
            ],
        ];

        if (isset($replace)) {
            $array = array_replace_recursive($array, $replace);
        }

        return Configuration::createFromArray($array);
    }

    public function test_can_instantiate_object()
    {
        $this->assertInstanceOf(Signature::class, new Signature);
    }

    public function test_can_get_signature_string()
    {
        $version = '7.0.5';
        $createdAt = '2017-11-24T21:56:15+00:00';
        $createdBy = 'xenial@xervo';
        $array = [
            'version' => $version,
            'createdAt' => $createdAt,
            'createdBy' => $createdBy,
        ];

        $configuration = $this->getConfiguration(['meta' => ['signature' => $array,]]);

        $expected = <<<SIGNATURE
##########################################
# Generated by avhost
# https://github.com/jpuck/avhost
# version $version
# createdAt $createdAt
# createdBy $createdBy
# contentHash {$configuration->getContentHash()}
# configuration {$configuration->toBase64()}
##########################################

SIGNATURE;

        $signature = Signature::createFromArray($array);

        $actual = $signature->render([
            'contentHash' => $configuration->getContentHash(),
            'configuration' => $configuration->toBase64(),
        ]);

        $this->assertSame($expected, $actual);
    }

    public function test_can_import_and_export_array()
    {
        $expected = [
            'version' => '1.0.1',
            'createdAt' => '2017-11-24T21:56:15+00:00',
            'createdBy' => 'jeff@xervo',
        ];

        $signature = Signature::createFromArray($expected);

        $exported = $signature->toArray();

        $actual = Signature::createFromArray($exported)->toArray();

        $this->assertEquals($expected, $actual);
    }
}
